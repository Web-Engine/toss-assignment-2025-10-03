[Interface]
Address = 10.0.0.1/24
ListenPort = 51820
Table = off
PrivateKey = +Ne3SIhtCwJIJl9qt8lTCmTRyN7ipu+ZoYTy2RfGz0c=

PostUp = modprobe nf_tproxy_ipv4 2>/dev/null || true
PostUp = modprobe nf_tproxy_ipv6 2>/dev/null || true
PostUp = modprobe xt_TPROXY 2>/dev/null || true
PostUp = modprobe nft_tproxy 2>/dev/null || true
PostUp = modprobe nfnetlink_queue 2>/dev/null || true

# 정책 라우팅: fwmark 1 -> table 100
PostUp = ip rule add fwmark 1 lookup 100 2>/dev/null || true
PostUp = ip route add local 0.0.0.0/0 dev lo table 100 2>/dev/null || true

# nft: table/chain 생성 (idempotent)
PostUp = nft add table ip mangle 2>/dev/null || true
PostUp = nft 'add chain ip mangle prerouting { type filter hook prerouting priority -150; }' 2>/dev/null || true

# conntrack mark -> skb mark 복원 규칙 (응답 패킷 라우팅 보장)
PostUp = nft list chain ip mangle prerouting 2>/dev/null | grep -Fq 'wg-restore-mark' || nft add rule ip mangle prerouting ct mark != 0 meta mark set ct mark comment "wg-restore-mark"

# TPROXY: unmarked 흐름을 프록시로 보냄 (ct mark == 0)
PostUp = nft list chain ip mangle prerouting 2>/dev/null | grep -Fq wg-tproxy-%i || nft add rule ip mangle prerouting iifname "%i" meta l4proto tcp ct mark 0 ct mark set 1 meta mark set 1 tproxy to :3129 comment \"wg-tproxy-%i\"

# NFQUEUE: 최초 패킷 검사용(사용자공간 검사기에서 읽음)
PostUp = nft add table ip raw 2>/dev/null || true
PostUp = nft 'add chain ip raw prerouting { type filter hook prerouting priority -300; }' 2>/dev/null || true
PostUp = nft list chain ip raw prerouting 2>/dev/null | grep -Fq "wg-inspect-queue-%i" || nft add rule ip raw prerouting iifname "%i" queue num 1 comment "wg-inspect-queue-%i"

# NFQUEUE rule 삭제 (raw prerouting)
PostDown = nft -a list chain ip raw prerouting 2>/dev/null | awk -v t="wg-inspect-queue-%i" '$0 ~ "rule" && $0 ~ t { for(i=1;i<=NF;i++) if ($i=="handle") print $(i+1) }' | while read h; do nft delete rule ip raw prerouting handle "$h" 2>/dev/null || true; done

# TPROXY 및 restore-mark 룰 삭제 (mangle prerouting, comment로 찾음)
PostDown = nft -a list chain ip mangle prerouting 2>/dev/null | awk -v t="wg-tproxy-%i" '$0 ~ "rule" && $0 ~ t { for(i=1;i<=NF;i++) if ($i=="handle") print $(i+1) }' | while read h; do nft delete rule ip mangle prerouting handle "$h" 2>/dev/null || true; done
PostDown = nft -a list chain ip mangle prerouting 2>/dev/null | awk -v t="wg-restore-mark" '$0 ~ "rule" && $0 ~ t { for(i=1;i<=NF;i++) if ($i=="handle") print $(i+1) }' | while read h; do nft delete rule ip mangle prerouting handle "$h" 2>/dev/null || true; done

# policy routing 제거
PostDown = ip route show table 100 | grep -q "local 0.0.0.0/0 dev lo" && ip route del local 0.0.0.0/0 dev lo table 100 2>/dev/null || true
PostDown = ip rule show | grep -q "fwmark 0x1 lookup 100" && ip rule del fwmark 1 lookup 100 2>/dev/null || true

[Peer]
PublicKey = DIg/M9qTGNLJ4QXVER4cjDCMQ9y1WLQ7XGGifDdhHms=
AllowedIPs = 10.0.0.2/32